---
title: AR-前后景处理-Overview
author: Jalen Cui
comments: true
categories: AR
date: 2023-03-22 01:33:12
tags: 
---

# 前言
本文着重梳理两年来博主在 AR 直播领域（渲染、推流、数据处理）的技术积累. 由下文的预备知识可知, 其中的每项都可以作为单独的专题展开讲解. 碍于全职工作, 近期不可能对所有的内容展开详尽讨论. 为避免遗忘这些宝贵的解决方案, 才有了这边文章.

# 预备知识
* __GPU 流水线__
    + 顶点数据: 模型通常由三角面 (或四边面) 组成. 在 GPU 渲染流程中，三角面片的顶点数据则是顶点着色器的输入，包括：位置, 法线, 切线, N 个纹理坐标以及颜色
        - 坐标系: 空间位置都是相对的. 
        日常技术沟通时，我们常说：A 坐标系在 B 坐标系下的表示; 点在某个坐标系下的表示;
            + A 类： 左手系, 右手系
            + B 类：模型坐标系, 相机坐标系, 世界坐标系
    + 集合阶段: 
        - __顶点着色器__: 顶点/片元着色器的第一个函数
            + 必要动作：完成顶点坐标从模型空间转换到齐次裁剪空间(`mul(UNITY_MVP, v.position)`)
            + 应用: 顶点动画, 低质量光照计算 
        - 曲面细分着色器: 可忽略哈, 99.9% 的技美不会接触到这里
        - 集合着色器: 同上可忽略, 如果感兴趣 google 一下
        - __裁剪__: 至关重要, 跟投影矩阵直接相关(正交投影, 透视投影)
        - __屏幕映射__: 至关重要, 3D --> 2D 
    + 光栅化阶段
        - 三角形设置: 固定函数阶段
        - 三角形遍历: 固定函数阶段
        - 片元着色器: 进行逐片元的着色操作. 顶点/片元着色器的第二个函数
        - 逐片元操作: 主要完成颜色, 深度缓冲, 混合等操作. 非可编程阶段, 开发人员 __不可直接介入__
    + 屏幕图像
* __Shader__ 
    + Shading Language: 列出几种常见的高级语言---可视为 __中间语言__ (Intermediate Language, IL). 这里的高级是相对于汇编语言来讲的, 并不是像 C# 相对于 C 的高级那种.
        - HLSL: DirectX 专用
        - GLSL: OpenGL 专用
        - CG: NVIDA 专用, 也即 `C for Graphic`. 在单个 `Pass` 通道, C 风格的代码通常被包围在 `CGPROGRAM` 和 `ENDCG` 之间。
    + Unity Shader: Unity 开发中, 有三种形式来编写 Unity Shader
        - 表面着色器 (Surface Shader): 噢噢噢噢，Unity 的宠儿. 使用这种着色器, 开发人员无需过多关注光照的处理细节
        - 顶点/片元着色器 (Vertex/Fragment Shader): 更加复杂, 灵活度更高. 博主全权负责开发的 AR 直播项目 100% 采用这种形式
        - 固定函数着色器 (Fixed Function Shader): 已经被抛弃, 也可以稍稍了解下

* __3D 空间变换__ : 投影，坐标变换
    + 坐标投影: 也即 3D ---> 2D, 从世界坐标系 ---> 投影平面的变换
        - 坐标变换: 依赖相机内参进行世界坐标到相机坐标的变换 依赖内参进行进一步到投影平面的操作
            + 相机外参: 世界坐标系到相机坐标系的变换 (__必须__)
            + 相机内参: 进一步变换到投影屏幕 (__可选__) (物理相机的畸变在大多数情况下可忽略, 但直播画面必须要进行处理)
        - 3D 点投影: 即消除系数 `Z` 的作用 (透视投影下, 平行线会在无穷远处相交. `Z` 可理解为深度信息或距离)
            + 齐次坐标系: `pos_2d = world2Proj * pos_3d`
            + 笛卡尔坐标系: `pos_2d = pos_2d / pos_2d.z`

* __3D 模型__ ：点云处理, 模型拼接  
    AR 字面义为 __增强现实__. 说白了, AR 也就是在现实世界的基础上增加些 __点缀__. 点缀容易, 但要点缀地恰到好处：
    + 视觉上: 让用户感到 __恰到好处__, 也即视野范围内的径向位置合适, 径向深度合适
    + 听觉上：让用户感受到那种 __由远及近的鸣笛声__

    本文重点讲解视觉上的效果处理 (后续有机会的话, 再对声音的多普勒效应模拟展开介绍). AR 增强现实要做到上述的效果, 离不开对现实世界的 __建模__ 和 __标定__. 对于不同的 AR 应用, 建模的方式有多种. 拿 LPL 直播效果, 盲猜他们会选择如下几种方式 (或者完全不需要, LPL 不需要对整个直播场地毫无遗漏的高精度要求)
    + 点云扫描：扫描精度不够, 尤其是边角处. 需要专业人员对从点云的导出模型进行修模 (如: 减面), 否侧很容易到达数百万顶点的模型文件
    + 设计模型：过于理想, 现场搭建的场地往往是组装起来的. 而组装的精度跟施工人员专业程度, 场地大小强相关
    + 设计模型拼接：相对比较节省人力, 节省时间的方式. 它的精度非常高.
        - 设计模型分快：按照实际场地的组装形式，对整体的设计模型进行拆分.
        - 场地标定：对搭建后的场地, 按需进行坐标点标定
        - 模型拼接：需要专用的模型拼接软件进行拼接. 作为当年的预研项, 博主当时好事三周完成了基本功能的开发
            + 模型动态导入: [插件](https://ricardoreis.net/trilib-a-unity-3d-file-loader-asset/)可用, 很好用
                - 模型缩放问题：可选缩放系数
                - 模型材质问题：需要遍历所有的 `material`, 有些模型会存在 submesh 的情况
            + 模型拼接并导出: Unity 官方插件可用, 依赖于 Editor 模式
                - 模型缩放问题：100:1 的差距
                - 模型格式问题：导入和导出的格式会涉及 fbx, obj, 因为我们是需要给模型贴图的. 某些情况下会生成光秃秃的模型哈哈哈哈
            + 模型点拾取: 实际上拾取的是三角面, 然后计算出距离拾取点最近的模型顶点. 注: 会存在多个三角面共点的情况
            + 刚体变换: 也即旋转、平移、缩放. 不难哈哈哈哈


* __相机内外参__
    内外参完全描述了物理相机的所有信息, 包括：相对于世界坐标系的变换, 相机的一些公差
    + 外参: 描述了相机的 __位姿__ 信息, 包括：旋转参数, 平移参数. 旋转通常由 __Euler__ 角描述, 可表示为 (qx, qy, qz, qw) 
    + 内参: 描述了相机的 __畸变__ 和相机参数信息, 包括: 内参矩阵, 畸变系数 
        - 内参系数: fx, fy, cx, cy
        - 畸变系数: 径向畸变, 切向畸变
            - 径向畸变: 来自透镜形状不规则及建模方式, 导致镜头不同区域焦距不同. 光线远离透镜中心的地方偏折更大 (枕型畸变) 或更小 (桶形畸变). 通常由 k1, k2, k3 表示
            - 切向畸变：来自整个相机的组装过程. 由于透镜制造上的缺陷, 使得透镜本身与图像平面不平行而产生的. 通常由 p1, p2 表示
# 简介

# 准备阶段

# 伪代码

# 附录